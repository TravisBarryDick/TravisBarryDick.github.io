(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var s=e.g.document;if(!t&&s&&(s.currentScript&&(t=s.currentScript.src),!t)){var i=s.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&!t;)t=i[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},s={};function i(e,t){const s=t.name;if(t.private)throw new Error(`'bound' cannot decorate private properties like ${s}.`);t.addInitializer((function(){this[s]=this[s].bind(this)}))}t.d(s,{wA:()=>n,JH:()=>h,GT:()=>c,YW:()=>d,We:()=>l,zp:()=>a,xT:()=>o,xP:()=>m,Js:()=>i,fy:()=>r});class n{tick(e,t){}on_add(e){}on_remove(e){}}class o{constructor(){this.map=new Map}get size(){return this.map.size}set(e,t){this.map.set(e,t)}get(e){return this.map.get(e)}has(e){return this.map.has(e)}delete(e){return this.map.delete(e)}clear(){this.map.clear()}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}forEach(e){for(let t of this.map.keys())e(t,this.map.get(t))}}function r(e){return Object.getPrototypeOf(e).constructor}class a{constructor(){this.handlers=new Array,this.messages=new Array}enqueue(e){this.messages.push(e)}add_handler(e){this.handlers.push(e)}remove_handler(e){const t=this.handlers.indexOf(e);-1!=t&&this.handlers.splice(t,1)}num_handlers(){return this.handlers.length}handle(){for(let e of this.messages)for(let t of this.handlers)t(e);this.messages.splice(0,this.messages.length)}}class l{constructor(){this.message_queues=new o}dispatch(e){const t=r(e),s=this.message_queues.get(t);void 0!==s&&s.enqueue(e)}add_handler(e,t){var s;this.message_queues.has(e)||this.message_queues.set(e,new a),null===(s=this.message_queues.get(e))||void 0===s||s.add_handler(t)}remove_handler(e,t){let s=this.message_queues.get(e);void 0!==s&&(s.remove_handler(t),0==s.num_handlers()&&this.message_queues.delete(e))}handle(){this.message_queues.forEach(((e,t)=>t.handle()))}}class h{constructor(){this.components=new o,this.message_dispatcher=new l}on_add(e){this.game=e}on_remove(e){this.game=void 0}add_component(e){let t=r(e);this.components.set(t,e),e.entity=this,this.game&&this.game.entity_component_tracker.register(this,t),e.on_add(this)}get_component(e){return this.components.get(e)}get_component_or_die(e){let t=this.get_component(e);if(void 0===t)throw new Error(`Tried to get component ${e.name} from entity that does not have it.`);return t}remove_component(e){let t=this.get_component(e);return t&&(t.entity=void 0,t.on_remove(this)),this.game&&this.game.entity_component_tracker.unregister(this,e),this.components.delete(e)}destroy(){for(let e of this.components.keys())this.remove_component(e)}tick(e,t){this.message_dispatcher.handle(),this.components.forEach(((s,i)=>i.tick(e,t))),this.message_dispatcher.handle()}}function _(e,t){if(e.size>t.size)return _(t,e);let s=new Set;for(let i of e)t.has(i)&&s.add(i);return s}class c{constructor(){this.listeners=new Map,this.component_to_entity=new Map}add_listener(e,t){var s;this.listeners.has(e)||this.listeners.set(e,new Set),null===(s=this.listeners.get(e))||void 0===s||s.add(t)}remove_listener(e,t){var s,i;null===(s=this.listeners.get(e))||void 0===s||s.delete(t),0==(null===(i=this.listeners.get(e))||void 0===i?void 0:i.size)&&this.listeners.delete(e)}register(e,t){var s;this.component_to_entity.has(t)||this.component_to_entity.set(t,new Set),null===(s=this.component_to_entity.get(t))||void 0===s||s.add(e);let i=this.listeners.get(t);if(i)for(let s of i)s("add",t,e)}unregister(e,t){var s;if(!this.component_to_entity.has(t))return;null===(s=this.component_to_entity.get(t))||void 0===s||s.delete(e);let i=this.listeners.get(t);if(i)for(let s of i)s("remove",t,e)}entities_with_component(e){const t=this.component_to_entity.get(e);return void 0===t?new Set:t}all_entities(){return function(...e){let t=new Set;for(let s of e)for(let e of s)t.add(e);return t}(...this.component_to_entity.values())}get_entities(e){if(0==e.length)return this.all_entities();e.sort(((e,t)=>this.entities_with_component(e).size-this.entities_with_component(t).size));let t=this.entities_with_component(e[0]);for(let s of e.slice(1))t=_(t,this.entities_with_component(s));return t}}class d{constructor(){this.entities=new Set,this.entity_component_tracker=new c,this.systems=new o,this.message_dispatcher=new l,this.last_time=void 0}create_entity(){let e=new h;return this.add_entity(e),e}add_entity(e){this.entities.add(e),e.on_add(this)}remove_entity(e){e.on_remove(this),e.destroy(),this.entities.delete(e)}add_system(e){const t=r(e);this.systems.set(t,e),e.game=this,e.on_add(this)}remove_system(e){let t=this.get_system(e);void 0!==t&&(t.on_remove(this),t.game=void 0,this.systems.delete(e))}has_system(e){return this.systems.has(e)}get_system(e){return this.systems.get(e)}get_system_or_die(e){let t=this.get_system(e);if(void 0===t)throw new Error(`Tried to get system ${e.name} from game that does not have it.`);return t}tick(e){void 0===this.last_time&&(this.last_time=e),this.message_dispatcher.handle();const t=e-this.last_time;for(let s of this.entities)s.tick(e,t);this.systems.forEach(((s,i)=>i.tick(e,t))),this.message_dispatcher.handle(),this.last_time=e}}class m{constructor(){this.message_dispatcher=new l}on_add(e){}on_remove(e){}get_entities(e){if(void 0===this.game)throw new Error("System is not attached to game and can not get_entities.");return this.game.entity_component_tracker.get_entities(e)}tick(e,t){this.message_dispatcher.handle()}}var u=s.wA,g=s.YW,p=s.xP,v=s.Js;class f{constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}add(e){return new f(this._x+e._x,this._y+e._y)}sub(e){return new f(this._x-e._x,this._y-e._y)}scale(e){return new f(this._x*e,this._y*e)}equals(e){return this.x==e.x&&this.y==e.y}toString(){return`Vec2(${this._x}, ${this._y})`}}function y(e,t){if(t.size<e.size)return y(t,e);let s=new Set;for(const i of e)t.has(i)&&s.add(i);return s}function w(e){for(let t of e)return t;throw new Error("Tried to get an element from an empty set.")}class x{constructor(){this.x_map=new Map,this._size=0}get size(){return this._size}set(e,t){var s;this.has(e)||(this._size+=1),this.x_map.has(e.x)||this.x_map.set(e.x,new Map),null===(s=this.x_map.get(e.x))||void 0===s||s.set(e.y,t)}get(e){var t;return null===(t=this.x_map.get(e.x))||void 0===t?void 0:t.get(e.y)}has(e){return void 0!==this.get(e)}delete(e){var t,s;return!!this.has(e)&&(null===(t=this.x_map.get(e.x))||void 0===t||t.delete(e.y),0==(null===(s=this.x_map.get(e.x))||void 0===s?void 0:s.size)&&this.x_map.delete(e.x),this._size-=1,!0)}}class b extends u{constructor(e){super(),this._pos=e}set pos(e){this._pos=e,this.system&&this.entity&&this.system.set_entity_position(this.entity,this.pos)}get pos(){return this._pos}}let k=(()=>{var e;let t,s=p,i=[];return e=class extends s{constructor(){super(),this.pos_to_entity=void function(e,t,s){for(var i=arguments.length>2,n=0;n<t.length;n++)s=i?t[n].call(e,s):t[n].call(e)}(this,i),this.pos_to_entity=new x,this.entity_to_pos=new Map}on_add(e){e.entity_component_tracker.add_listener(b,this.component_listener)}on_remove(e){e.entity_component_tracker.remove_listener(b,this.component_listener)}component_listener(e,t,s){if("remove"==e){this.remove_entity(s);let e=s.get_component(b);e&&(e.system=void 0)}else{let e=s.get_component(b);if(void 0===e)return;e.system=this,this.set_entity_position(s,e.pos)}}set_entity_position(e,t){var s,i;let n=this.entity_to_pos.get(e);void 0!==n&&(null===(s=this.pos_to_entity.get(n))||void 0===s||s.delete(e)),this.entity_to_pos.set(e,t),this.pos_to_entity.has(t)||this.pos_to_entity.set(t,new Set),null===(i=this.pos_to_entity.get(t))||void 0===i||i.add(e)}remove_entity(e){var t;let s=this.entity_to_pos.get(e);void 0!==s&&(null===(t=this.pos_to_entity.get(s))||void 0===t||t.delete(e)),this.entity_to_pos.delete(e)}entities_at(e,t=void 0){let s=this.pos_to_entity.get(e);return void 0===s&&(s=new Set),void 0!==t&&(s=y(s,this.get_entities(t))),s}position_of(e){return this.entity_to_pos.get(e)}},(()=>{var n;const o="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(n=s[Symbol.metadata])&&void 0!==n?n:null):void 0;t=[v],function(e,t,s,i,n,o){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=i.kind,h="getter"===l?"get":"setter"===l?"set":"value",_=!t&&e?i.static?e:e.prototype:null,c=t||(_?Object.getOwnPropertyDescriptor(_,i.name):{}),d=!1,m=s.length-1;m>=0;m--){var u={};for(var g in i)u[g]="access"===g?{}:i[g];for(var g in i.access)u.access[g]=i.access[g];u.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");o.push(r(e||null))};var p=(0,s[m])("accessor"===l?{get:c.get,set:c.set}:c[h],u);if("accessor"===l){if(void 0===p)continue;if(null===p||"object"!=typeof p)throw new TypeError("Object expected");(a=r(p.get))&&(c.get=a),(a=r(p.set))&&(c.set=a),(a=r(p.init))&&n.unshift(a)}else(a=r(p))&&("field"===l?n.unshift(a):c[h]=a)}_&&Object.defineProperty(_,i.name,c),d=!0}(e,null,t,{kind:"method",name:"component_listener",static:!1,private:!1,access:{has:e=>"component_listener"in e,get:e=>e.component_listener},metadata:o},null,i),o&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:o})})(),e})();class z extends u{constructor(e){super(),this.color_ix=e}}class E extends u{constructor(e=void 0){super(),this.held_color=e}}class S extends u{}class j extends u{constructor(e){super(),this.color_ix=e}}(()=>{var e;let t,s=p,i=[];e=class extends s{on_add(e){e.message_dispatcher.add_handler(C,this.on_pickup_color)}on_remove(e){e.message_dispatcher.remove_handler(C,this.on_pickup_color)}on_pickup_color(e){if(void 0===this.game)return;let t=w(this.get_entities([E])),s=t.get_component_or_die(b).pos,i=this.game.get_system_or_die(k).entities_at(s,[j]),n=t.get_component_or_die(E).held_color;if(void 0!==n){t.get_component_or_die(E).held_color=void 0;let e=this.game.create_entity();e.add_component(new j(n)),e.add_component(new b(s))}if(i.size>0){let e=w(i);t.get_component_or_die(E).held_color=e.get_component_or_die(j).color_ix,e.destroy(),this.game.remove_entity(e)}}constructor(){super(...arguments),function(e,t,s){for(var i=arguments.length>2,n=0;n<t.length;n++)s=i?t[n].call(e,s):t[n].call(e)}(this,i)}},(()=>{var n;const o="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(n=s[Symbol.metadata])&&void 0!==n?n:null):void 0;t=[v],function(e,t,s,i,n,o){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=i.kind,h="getter"===l?"get":"setter"===l?"set":"value",_=!t&&e?i.static?e:e.prototype:null,c=t||(_?Object.getOwnPropertyDescriptor(_,i.name):{}),d=!1,m=s.length-1;m>=0;m--){var u={};for(var g in i)u[g]="access"===g?{}:i[g];for(var g in i.access)u.access[g]=i.access[g];u.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");o.push(r(e||null))};var p=(0,s[m])("accessor"===l?{get:c.get,set:c.set}:c[h],u);if("accessor"===l){if(void 0===p)continue;if(null===p||"object"!=typeof p)throw new TypeError("Object expected");(a=r(p.get))&&(c.get=a),(a=r(p.set))&&(c.set=a),(a=r(p.init))&&n.unshift(a)}else(a=r(p))&&("field"===l?n.unshift(a):c[h]=a)}_&&Object.defineProperty(_,i.name,c),d=!0}(e,null,t,{kind:"method",name:"on_pickup_color",static:!1,private:!1,access:{has:e=>"on_pickup_color"in e,get:e=>e.on_pickup_color},metadata:o},null,i),o&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:o})})()})();class O{}class P{}var T=function(e,t,s,i,n,o){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=i.kind,h="getter"===l?"get":"setter"===l?"set":"value",_=!t&&e?i.static?e:e.prototype:null,c=t||(_?Object.getOwnPropertyDescriptor(_,i.name):{}),d=!1,m=s.length-1;m>=0;m--){var u={};for(var g in i)u[g]="access"===g?{}:i[g];for(var g in i.access)u.access[g]=i.access[g];u.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");o.push(r(e||null))};var p=(0,s[m])("accessor"===l?{get:c.get,set:c.set}:c[h],u);if("accessor"===l){if(void 0===p)continue;if(null===p||"object"!=typeof p)throw new TypeError("Object expected");(a=r(p.get))&&(c.get=a),(a=r(p.set))&&(c.set=a),(a=r(p.init))&&n.unshift(a)}else(a=r(p))&&("field"===l?n.unshift(a):c[h]=a)}_&&Object.defineProperty(_,i.name,c),d=!0};const I=new f(0,-1),M=new f(0,1),q=new f(1,0),L=new f(-1,0);class ${constructor(e){this.direction=e}}class C{}(()=>{var e;let t,s,i,n=p,o=[];e=class extends n{constructor(){super(),this.enabled=void function(e,t,s){for(var i=arguments.length>2,n=0;n<t.length;n++)s=i?t[n].call(e,s):t[n].call(e)}(this,o),this.enabled=!0}on_add(e){window.addEventListener("keydown",this.on_key_down),e.message_dispatcher.add_handler(O,this.on_transition_start),e.message_dispatcher.add_handler(P,this.on_transition_end)}on_remove(e){window.removeEventListener("keydown",this.on_key_down),e.message_dispatcher.remove_handler(O,this.on_transition_start),e.message_dispatcher.remove_handler(P,this.on_transition_end)}on_transition_start(e){this.enabled=!1}on_transition_end(e){this.enabled=!0}on_key_down(e){if(void 0===this.game)return;if(!this.enabled)return;const t=e.key.toLowerCase();"w"==t&&(this.game.message_dispatcher.dispatch(new $(I)),this.game.tick((this.game.last_time||0)+1)),"s"==t&&(this.game.message_dispatcher.dispatch(new $(M)),this.game.tick((this.game.last_time||0)+1)),"a"==t&&(this.game.message_dispatcher.dispatch(new $(L)),this.game.tick((this.game.last_time||0)+1)),"d"==t&&(this.game.message_dispatcher.dispatch(new $(q)),this.game.tick((this.game.last_time||0)+1)),"x"==t&&(this.game.message_dispatcher.dispatch(new C),this.game.tick((this.game.last_time||0)+1))}},(()=>{var r;const a="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(r=n[Symbol.metadata])&&void 0!==r?r:null):void 0;t=[v],s=[v],i=[v],T(e,null,t,{kind:"method",name:"on_transition_start",static:!1,private:!1,access:{has:e=>"on_transition_start"in e,get:e=>e.on_transition_start},metadata:a},null,o),T(e,null,s,{kind:"method",name:"on_transition_end",static:!1,private:!1,access:{has:e=>"on_transition_end"in e,get:e=>e.on_transition_end},metadata:a},null,o),T(e,null,i,{kind:"method",name:"on_key_down",static:!1,private:!1,access:{has:e=>"on_key_down"in e,get:e=>e.on_key_down},metadata:a},null,o),a&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:a})})()})();let F=(()=>{var e;let t,s=p,i=[];return e=class extends s{constructor(e){super(),this.num_colors=(function(e,t,s){for(var i=arguments.length>2,n=0;n<t.length;n++)s=i?t[n].call(e,s):t[n].call(e)}(this,i),e)}on_add(e){e.message_dispatcher.add_handler($,this.on_movement_request)}on_remove(e){e.message_dispatcher.remove_handler($,this.on_movement_request)}get_adjacent_colors(e){let t=new Set;for(let s of e)t.add(s),t.add(0==s?this.num_colors-1:s-1),t.add(s==this.num_colors-1?0:s+1);return t}get_tile_color(e){if(void 0===this.game)throw new Error("Called get_tile_color outside of game.");let t=y(this.game.get_system_or_die(k).entities_at(e),this.get_entities([z]));for(let e of t)return e.get_component_or_die(z).color_ix}get_player_colors(){if(void 0===this.game)throw new Error("Tried to get player colors outside of game.");let e=new Set,t=w(this.get_entities([E,b])),s=t.get_component_or_die(E).held_color;void 0!==s&&e.add(s);let i=t.get_component_or_die(b).pos,n=this.get_tile_color(i);return void 0!==n&&e.add(n),e}can_move_in_dir(e){if(void 0===this.game)return!1;let t=w(this.get_entities([E,b])).get_component_or_die(b).pos,s=t.add(e);return this.can_move(t,s)}can_move(e,t){if(!this.game)return!1;let s=this.game.get_system_or_die(k),i=w(this.get_entities([E])).get_component_or_die(E).held_color,n=s.entities_at(e,[z]),o=s.entities_at(t,[z]);if(0==n.size||0==o.size)return!1;let r=new Set([w(n).get_component_or_die(z).color_ix]);i&&r.add(i);let a=w(o).get_component_or_die(z).color_ix;return this.get_adjacent_colors(r).has(a)}on_movement_request(e){if(this.can_move_in_dir(e.direction)){let t=w(this.get_entities([E,b])).get_component_or_die(b);t.pos=t.pos.add(e.direction)}}},(()=>{var n;const o="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(n=s[Symbol.metadata])&&void 0!==n?n:null):void 0;t=[v],function(e,t,s,i,n,o){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=i.kind,h="getter"===l?"get":"setter"===l?"set":"value",_=!t&&e?i.static?e:e.prototype:null,c=t||(_?Object.getOwnPropertyDescriptor(_,i.name):{}),d=!1,m=s.length-1;m>=0;m--){var u={};for(var g in i)u[g]="access"===g?{}:i[g];for(var g in i.access)u.access[g]=i.access[g];u.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");o.push(r(e||null))};var p=(0,s[m])("accessor"===l?{get:c.get,set:c.set}:c[h],u);if("accessor"===l){if(void 0===p)continue;if(null===p||"object"!=typeof p)throw new TypeError("Object expected");(a=r(p.get))&&(c.get=a),(a=r(p.set))&&(c.set=a),(a=r(p.init))&&n.unshift(a)}else(a=r(p))&&("field"===l?n.unshift(a):c[h]=a)}_&&Object.defineProperty(_,i.name,c),d=!0}(e,null,t,{kind:"method",name:"on_movement_request",static:!1,private:!1,access:{has:e=>"on_movement_request"in e,get:e=>e.on_movement_request},metadata:o},null,i),o&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:o})})(),e})();const A=e.p+"2086bfb7af05b226f9fa.png",B=e.p+"9cf89a82b94fb9bc5b41.png",D=e.p+"ea6260ff38396f7bd3c3.png",V=e.p+"880b629e4fcd2a259c93.png";new f(1,0),new f(-1,0),new f(0,1),new f(0,-1);class W extends p{constructor(e){super(),this.canvas=e.canvas;let t=this.canvas.getContext("2d");if(null===t)throw new Error("Could not create rendering context.");this.ctx=t,this.tile_size=e.tile_size,this.colors=e.colors,this.player=document.createElement("img"),this.player.src=A,this.goal=document.createElement("img"),this.goal.src=B,this.wall=document.createElement("img"),this.wall.src=D,this.one_way_wall=document.createElement("img"),this.one_way_wall.src=V;for(let e of[this.player,this.goal,this.wall,this.one_way_wall])e.onload=()=>this.render()}set_level_size(e){this.level_size=e,this.canvas.width=e.x*this.tile_size,this.canvas.height=e.y*this.tile_size}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.draw_tiles(),this.draw_walls(),this.draw_goal(),this.draw_orbs(),this.draw_player()}draw_player(){for(let e of this.get_entities([E,b])){let t=e.get_component_or_die(b).pos;this.draw_img(this.player,t.add(new f(.5,.5)).scale(this.tile_size));let s=e.get_component_or_die(E).held_color;void 0!==s&&(this.ctx.fillStyle=this.colors[s],this.ctx.beginPath(),this.ctx.ellipse((t.x+.5+.2)*this.tile_size,(t.y+.5+.1)*this.tile_size,.1*this.tile_size,.1*this.tile_size,0,0,360),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke())}}draw_orbs(){for(let e of this.get_entities([j,b])){let t=e.get_component_or_die(b).pos,s=e.get_component_or_die(j).color_ix;this.ctx.fillStyle=this.colors[s],this.ctx.beginPath(),this.ctx.ellipse((t.x+.5)*this.tile_size,(t.y+.5)*this.tile_size,.4*this.tile_size,.4*this.tile_size,0,0,2*Math.PI),this.ctx.closePath(),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke()}}draw_goal(){for(let e of this.get_entities([S])){let t=e.get_component_or_die(b).pos;this.draw_img(this.goal,t.add(new f(.5,.5)).scale(this.tile_size))}}draw_tiles(){for(let e of this.get_entities([z,b])){let t=e.get_component_or_die(b).pos,s=e.get_component_or_die(z).color_ix;this.ctx.fillStyle=this.colors[s],this.ctx.fillRect(t.x*this.tile_size,t.y*this.tile_size,this.tile_size,this.tile_size)}}draw_wall(e,t){if(void 0===this.game)return;let s=e,i=e.add("right"==t?new f(1,0):new f(0,1)),n=this.game.get_system_or_die(k),o=this.game.get_system_or_die(F);if(0==n.entities_at(s,[z]).size||0==n.entities_at(i,[z]).size)return;let r=o.can_move(s,i),a=o.can_move(i,s),l="right"==t?e.add(new f(1,.5)).scale(this.tile_size):e.add(new f(.5,1)).scale(this.tile_size);this.ctx.save(),r||a?r&&!a?(this.ctx.translate(l.x,l.y),"down"==t&&this.ctx.rotate(Math.PI/2),this.draw_img(this.one_way_wall,new f(0,0))):!r&&a&&(this.ctx.translate(l.x,l.y),"down"==t&&this.ctx.rotate(Math.PI/2),this.ctx.scale(-1,1),this.draw_img(this.one_way_wall,new f(0,0))):(this.ctx.translate(l.x,l.y),"down"==t&&this.ctx.rotate(Math.PI/2),this.draw_img(this.wall,new f(0,0))),this.ctx.restore()}draw_walls(){for(let e of this.get_entities([z,b])){let t=e.get_component_or_die(b).pos;this.draw_wall(t,"right"),this.draw_wall(t,"down")}}draw_img(e,t){this.ctx.drawImage(e,t.x-e.width/2,t.y-e.height/2)}tick(e,t){this.render()}}var Y=function(e,t,s){for(var i=arguments.length>2,n=0;n<t.length;n++)s=i?t[n].call(e,s):t[n].call(e);return i?s:void 0},J=function(e,t,s,i,n,o){function r(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,l=i.kind,h="getter"===l?"get":"setter"===l?"set":"value",_=!t&&e?i.static?e:e.prototype:null,c=t||(_?Object.getOwnPropertyDescriptor(_,i.name):{}),d=!1,m=s.length-1;m>=0;m--){var u={};for(var g in i)u[g]="access"===g?{}:i[g];for(var g in i.access)u.access[g]=i.access[g];u.addInitializer=function(e){if(d)throw new TypeError("Cannot add initializers after decoration has completed");o.push(r(e||null))};var p=(0,s[m])("accessor"===l?{get:c.get,set:c.set}:c[h],u);if("accessor"===l){if(void 0===p)continue;if(null===p||"object"!=typeof p)throw new TypeError("Object expected");(a=r(p.get))&&(c.get=a),(a=r(p.set))&&(c.set=a),(a=r(p.init))&&n.unshift(a)}else(a=r(p))&&("field"===l?n.unshift(a):c[h]=a)}_&&Object.defineProperty(_,i.name,c),d=!0};let N=new g;const R=["#FAEB36","#90EE90","#79C314","#008080","#487DE7","#3532B2","#70369D","#F33A6A","#E81416","#FF7336","#FFA500","#FDCB18"];class X{}let G=(()=>{var e;let t,s,i,n,o,r,a,l=p,h=[];return e=class extends l{constructor(e){super(),this.canvas=(Y(this,h),e),this.mouse_pos=new f(0,0),this.mouse_down=!1,this.keys=new Set}on_add(e){this.canvas.addEventListener("mousemove",this.on_mouse_move),this.canvas.addEventListener("mousedown",this.on_mouse_down),this.canvas.addEventListener("mouseup",this.on_mouse_up),window.addEventListener("keydown",this.on_key_down),window.addEventListener("keyup",this.on_key_up),e.message_dispatcher.add_handler(X,this.serialize)}on_remove(e){this.canvas.removeEventListener("mousemove",this.on_mouse_move),this.canvas.removeEventListener("mousedown",this.on_mouse_down),this.canvas.removeEventListener("mouseup",this.on_mouse_up),window.removeEventListener("keydown",this.on_key_down),window.removeEventListener("keyup",this.on_key_up),e.message_dispatcher.remove_handler(X,this.serialize)}on_key_down(e){this.keys.add(e.key.toLowerCase())}on_key_up(e){this.keys.delete(e.key.toLowerCase())}on_mouse_move(e){if(!this.game)return;let t=this.game.get_system_or_die(W).tile_size,s=(i=new f(Math.floor(e.offsetX/t),Math.floor(e.offsetY/t)),n=this.get_level_size(),new f(Math.max(0,Math.min(i.x,n.x-1)),Math.max(0,Math.min(i.y,n.y-1))));var i,n;s.equals(this.mouse_pos)||(this.mouse_pos=s,this.mouse_down&&this.on_drag())}on_mouse_down(e){if(this.game)if(this.keys.has("g"))this.set_goal(this.mouse_pos);else if(this.keys.has("s"))this.set_start(this.mouse_pos);else if(this.keys.has("o")){let e=this.game.get_system_or_die(H).selected_color;this.set_orb(this.mouse_pos,e)}else this.keys.has("d")?this.remove_orb(this.mouse_pos):(this.mouse_down=!0,this.on_drag())}on_mouse_up(e){this.mouse_down=!1}on_drag(){if(!this.game)return;let e=this.game.get_system_or_die(H),t=e.selected_color;this.set_tile_color(this.mouse_pos,t),this.keys.has("a")?e.set_color(t+1):this.keys.has("z")&&e.set_color(t-1)}get_level_size(){if(!this.game)return new f(0,0);return this.game.get_system_or_die(W).level_size||new f(0,0)}get_tile_color(e){if(!this.game)return;let t=this.game.get_system_or_die(k);for(let s of t.entities_at(e,[z]))return s.get_component_or_die(z).color_ix}set_tile_color(e,t){if(!this.game)return;let s=this.game.get_system_or_die(k);for(let t of s.entities_at(e,[z]))t.destroy(),this.game.remove_entity(t);let i=this.game.create_entity();i.add_component(new b(e)),i.add_component(new z(t))}set_orb(e,t){if(!this.game)return;let s=this.game.get_system_or_die(k);for(let t of s.entities_at(e,[j]))t.destroy(),N.remove_entity(t);let i=this.game.create_entity();i.add_component(new b(e)),i.add_component(new j(t))}remove_orb(e){if(!this.game)return;let t=this.game.get_system_or_die(k);for(let s of t.entities_at(e,[j]))s.destroy(),N.remove_entity(s)}set_goal(e){if(!this.game)return;for(let e of this.get_entities([S]))e.destroy(),this.game.remove_entity(e);let t=this.game.create_entity();t.add_component(new b(e)),t.add_component(new S)}set_start(e){if(!this.game)return;for(let e of this.get_entities([E]))e.destroy(),this.game.remove_entity(e);let t=this.game.create_entity();t.add_component(new b(e)),t.add_component(new E)}serialize(e){if(!this.game)return;let t=this.get_level_size(),s="new LevelCreator(\n`\n";for(let e=0;e<t.y;e++){for(let i=0;i<t.x;i++){let t=this.get_tile_color(new f(i,e));void 0===t?s+=".":t<10?s+=`${t}`:10==t?s+="A":11==t&&(s+="B")}s+="\n"}s+="`,\n";let i=this.get_entities([E,b]);if(0==i.size)return"No start position!";let n=w(i).get_component_or_die(b).pos;s+=`new Vec2(${n.x}, ${n.y}),`;let o=this.get_entities([S,b]);if(0==o.size)return"No goal position!";let r=w(o).get_component_or_die(b).pos;s+=`\nnew Vec2(${r.x}, ${r.y})`,s+=")";let a=document.getElementById("message");""!=a.value&&(s+=`\n.set_message("${a.value}")`);for(let e of this.get_entities([j,b])){let t=e.get_component_or_die(j).color_ix,i=e.get_component_or_die(b).pos;s+=`\n.add_orb(new Vec2(${i.x}, ${i.y}), ${t})`}s+=";",console.log(s)}},(()=>{var _;const c="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(_=l[Symbol.metadata])&&void 0!==_?_:null):void 0;t=[v],s=[v],i=[v],n=[v],o=[v],r=[v],a=[v],J(e,null,t,{kind:"method",name:"on_key_down",static:!1,private:!1,access:{has:e=>"on_key_down"in e,get:e=>e.on_key_down},metadata:c},null,h),J(e,null,s,{kind:"method",name:"on_key_up",static:!1,private:!1,access:{has:e=>"on_key_up"in e,get:e=>e.on_key_up},metadata:c},null,h),J(e,null,i,{kind:"method",name:"on_mouse_move",static:!1,private:!1,access:{has:e=>"on_mouse_move"in e,get:e=>e.on_mouse_move},metadata:c},null,h),J(e,null,n,{kind:"method",name:"on_mouse_down",static:!1,private:!1,access:{has:e=>"on_mouse_down"in e,get:e=>e.on_mouse_down},metadata:c},null,h),J(e,null,o,{kind:"method",name:"on_mouse_up",static:!1,private:!1,access:{has:e=>"on_mouse_up"in e,get:e=>e.on_mouse_up},metadata:c},null,h),J(e,null,r,{kind:"method",name:"on_drag",static:!1,private:!1,access:{has:e=>"on_drag"in e,get:e=>e.on_drag},metadata:c},null,h),J(e,null,a,{kind:"method",name:"serialize",static:!1,private:!1,access:{has:e=>"serialize"in e,get:e=>e.serialize},metadata:c},null,h),c&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:c})})(),e})(),H=(()=>{var e;let t,s,i=p,n=[];return e=class extends i{constructor(e){super(),this.canvas=(Y(this,n),e);let t=e.getContext("2d");if(!t)throw new Error("Could not get canvas rendering context.");this.ctx=t,this.mouse_pos=new f(0,0),this.selected_color=0,this.render()}on_add(e){this.canvas.addEventListener("mousemove",this.on_mouse_move),this.canvas.addEventListener("mousedown",this.on_click)}on_remove(e){this.canvas.removeEventListener("mousemove",this.on_mouse_move),this.canvas.removeEventListener("mousedown",this.on_click)}on_mouse_move(e){this.mouse_pos=new f(e.offsetX,e.offsetY)}on_click(e){if(!this.game)return;let t=Math.atan2(-(this.canvas.height/2-this.mouse_pos.y),-(this.canvas.width/2-this.mouse_pos.x)),s=Math.floor(t/(2*Math.PI)*R.length);if(s<0&&(s+=R.length),e.shiftKey){for(let e of this.get_entities([E])){let t=e.get_component_or_die(E);t.held_color==s?t.held_color=void 0:t.held_color=s}e.preventDefault()}else this.set_color(s)}set_color(e){(e%=R.length)<0&&(e+=R.length),this.selected_color=e,this.render()}wedge_path(e){this.ctx.beginPath(),this.ctx.moveTo(this.canvas.width/2,this.canvas.height/2),this.ctx.ellipse(this.canvas.width/2,this.canvas.height/2,this.canvas.width/2*.9,this.canvas.height/2*.9,0,2*e*Math.PI/R.length,2*(e+1)*Math.PI/R.length),this.ctx.closePath()}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);let e=0;for(let t of R)this.ctx.fillStyle=t,this.wedge_path(e),this.ctx.fill(),e+=1;this.wedge_path(this.selected_color),this.ctx.lineWidth=3,this.ctx.stroke()}},(()=>{var o;const r="function"==typeof Symbol&&Symbol.metadata?Object.create(null!==(o=i[Symbol.metadata])&&void 0!==o?o:null):void 0;t=[v],s=[v],J(e,null,t,{kind:"method",name:"on_mouse_move",static:!1,private:!1,access:{has:e=>"on_mouse_move"in e,get:e=>e.on_mouse_move},metadata:r},null,n),J(e,null,s,{kind:"method",name:"on_click",static:!1,private:!1,access:{has:e=>"on_click"in e,get:e=>e.on_click},metadata:r},null,n),r&&Object.defineProperty(e,Symbol.metadata,{enumerable:!0,configurable:!0,writable:!0,value:r})})(),e})();N.add_system(new k),N.add_system(new F(R.length)),N.add_system(new W({canvas:document.getElementById("canvas"),tile_size:50,colors:R})),N.add_system(new G(document.getElementById("canvas"))),N.add_system(new H(document.getElementById("color_selector")));let K=N.create_entity();K.add_component(new E),K.add_component(new b(new f(-1,-1))),window.set_level_size=()=>{let e=document.getElementById("level_width"),t=document.getElementById("level_height"),s=parseInt(e.value),i=parseInt(t.value),n=new f(s,i),o=N.get_system_or_die(W);o.set_level_size(n),o.render()},window.serialize=()=>{N.message_dispatcher.dispatch(new X)},window.requestAnimationFrame((function e(t){N.tick(t/1e3),window.requestAnimationFrame(e)})),window.set_level_size(),window.game=N})();